<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | TNP Portal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; color: #002147; }
    .header { background-color: #002147; color: white; padding: 16px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .main { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
    .btn { background-color: #007bff; color: white; border: none; border-radius: 6px; padding: 10px 16px; cursor: pointer; font-weight: bold; transition: 0.3s ease; }
    .btn:hover { background-color: #0056b3; }
    .section { background: white; padding: 25px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .section h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    input[type="text"], input[type="file"], input[type="url"] { width: 100%; padding: 10px; margin-top: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px; }
    .profile-card { display: flex; align-items: center; justify-content: space-between; }
    .info h2 { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>Student Dashboard</h2>
    <div>
      <button class="btn" onclick="viewProfile()">View Public Profile</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="section profile-card">
      <div class="info">
        <h2 id="student-name">Loading...</h2>
        <p>Indian Institute of Information Technology, Manipur</p>
      </div>
      <button class="btn" onclick="updateMainProfile()">Save Name/Branch</button>
    </div>

    <div class="section">
      <h3>Update Basic Info</h3>
      <input type="text" id="edit-name" placeholder="Full Name" />
      <input type="text" id="edit-branch" placeholder="Branch (e.g., CSE)" />
    </div>

    <div class="section">
      <h3>Resume</h3>
      <input type="file" id="resume-input" accept=".pdf" onchange="uploadResume()" />
    </div>

    <div class="section">
      <h3>Skills</h3>
      <input type="text" id="new-skill" placeholder="Add a skill (e.g., Python)" />
      <button class="btn" onclick="addSkill()">Add Skill</button>
    </div>

    <div class="section">
      <h3>Work Experience</h3>
      <input type="text" id="exp-title" placeholder="Job Title" />
      <input type="text" id="exp-company" placeholder="Company" />
      <input type="text" id="exp-duration" placeholder="Duration (e.g., Jan 2024 - Present)" />
      <input type="text" id="exp-description" placeholder="Brief Description" />
      <button class="btn" onclick="addExperience()">Add Experience</button>
    </div>
    
    </div>

  <script>
    const token = localStorage.getItem("studentToken");
    let studentId = null; // Will be set on load

    if (!token) {
      alert("Please log in.");
      window.location.href = "multi-login.html";
    }

    function logout() {
      localStorage.removeItem("studentToken");
      window.location.href = "multi-login.html";
    }

    // âœ… UPDATED to navigate to the correct file name
    function viewProfile() {
      if (studentId) {
        window.location.href = `student-profile-view.html?id=${studentId}`;
      } else {
        alert("Profile is still loading, please wait.");
      }
    }

    function updateApi(endpoint, body) {
        return fetch(`/api/students/me/${endpoint}`, {
            method: "PATCH",
            headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(res => {
            if (!res.ok) throw new Error("Update failed");
            alert("Profile updated successfully!");
            // Optionally reload or update UI without full reload
        });
    }
    
    function addSkill() {
      const skill = document.getElementById("new-skill").value;
      if(skill) updateApi('skills', { skill }).catch(err => alert(err.message));
    }

    function addExperience() {
      const experience = {
        title: document.getElementById("exp-title").value,
        company: document.getElementById("exp-company").value,
        duration: document.getElementById("exp-duration").value,
        description: document.getElementById("exp-description").value
      };
      if(experience.title) updateApi('experience', experience).catch(err => alert(err.message));
    }
    
    function updateMainProfile() {
        const profile = {
            name: document.getElementById("edit-name").value,
            branch: document.getElementById("edit-branch").value
        };
        if(profile.name) updateApi('', profile).catch(err => alert(err.message));
    }

    function uploadResume() {
        const file = document.getElementById("resume-input").files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append("resume", file);

        fetch("/api/upload/resume", {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData
        })
        .then(res => res.json())
        .then(() => alert("Resume uploaded successfully"))
        .catch(() => alert("Resume upload failed"));
    }

    // Initial load of student data to populate fields
    fetch("/api/students/me", {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
      studentId = data._id; // Set the global studentId
      document.getElementById("student-name").textContent = data.name;
      document.getElementById("edit-name").value = data.name;
      document.getElementById("edit-branch").value = data.branch;
    });
  </script>
</body>
</html>