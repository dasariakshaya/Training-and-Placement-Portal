<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - View Applications | TNP Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; margin: 0; padding: 0; }
    .dashboard { display: flex; min-height: 100vh; }
    .sidebar { width: 240px; background-color: #002147; color: #fff; padding: 20px; display: flex; flex-direction: column; }
    .sidebar .logo { font-size: 1.6rem; font-weight: bold; margin-bottom: 30px; text-align: center; }
    .sidebar nav a { color: #fff; text-decoration: none; padding: 12px 15px; border-radius: 8px; margin: 5px 0; display: block; transition: background-color: 0.3s; }
    .sidebar nav a:hover, .sidebar nav a.active { background-color: #004080; }
    .main { flex-grow: 1; padding: 30px; }
    h2 { color: #002147; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
    th, td { padding: 12px 16px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background-color: #002147; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    
    /* ✅ FIXED: Made this rule more specific to only affect links in the main content */
    .main a { 
        color: #002147; 
        text-decoration: none; 
        font-weight: bold; 
    }

    .status { padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; color: white; display: inline-block; text-transform: capitalize; }
    .status.applied { background-color: #7f8c8d; }
    .status.interview { background-color: #3498db; }
    .status.selected { background-color: #27ae60; }
    .status.rejected { background-color: #c0392b; }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo">Admin Panel</div>
      <nav>
        <a href="admin-dashboard.html">Dashboard</a>
        <a href="admin-manage-jobs.html">Job Management</a>
        <a href="admin-applications.html" class="active">View Applications</a>
        <a href="admin-placed.html">Mark Placed</a>
        
        <a href="admin-export.html">Export CSV</a>
      </nav>
    </aside>

    <main class="main">
      <h2>All Applications</h2>
      <table id="applicationsTable">
        <thead>
          <tr>
            <th>Student</th>
            <th>Email</th>
            <th>Resume</th>
            <th>Job Title</th>
            <th>Company</th>
            <th>Status</th>
            <th>Interview Date</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7">Loading applications...</td></tr>
        </tbody>
      </table>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:3000';
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin first.");
      window.location.href = "multi-login.html";
    }

    fetch(`${API_BASE_URL}/api/admin/applications`, {
      headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        return res.json();
    })
    .then(applications => {
      const tbody = document.querySelector("#applicationsTable tbody");
      tbody.innerHTML = "";

      if (!applications.length) {
        tbody.innerHTML = "<tr><td colspan='7'>No applications found.</td></tr>";
        return;
      }

      applications.forEach(app => {
        const tr = document.createElement("tr");
        const resumeLink = app.studentId.resumeLink
            ? `<a href="${API_BASE_URL}${app.studentId.resumeLink}" target="_blank">View</a>`
            : 'N/A';
            
        tr.innerHTML = `
          <td>${app.studentId.name}</td>
          <td>${app.studentId.email}</td>
          <td>${resumeLink}</td>
          <td>${app.jobId.title}</td>
          <td>${app.jobId.company}</td>
          <td><span class="status ${app.status}">${app.status}</span></td>
          <td>${app.interviewDate ? new Date(app.interviewDate).toLocaleString() : '—'}</td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error("Failed to load applications", err);
      alert("❌ Could not fetch applications. Check the console for errors.");
    });
  </script>
</body>
</html>